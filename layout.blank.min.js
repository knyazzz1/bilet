if (!window.lsport) window.lsport = {};
if (!window.lsport.templates) window.lsport.templates = {};
function alert(msg, btn, callback, activateCallback) {
    if (!window.lsport.winAlert) {
        window.lsport.winAlert = $("<div><div class='m-2 k-w-full' id='alert-content'></div><div class='d-flex justify-content-center'><button type='button' class='k-button k-button-md k-rounded-full k-button-outline k-button-outline-secondary' id='alert-close'></button></div></div>").kendoWindow({
            modal: { preventScroll: true }, visible: false, animation: false,
            open: function (e) {
                e.sender.wrapper.css({ "max-width": "70vw", "max-height": "500px" });
                e.sender.wrapper.find(".k-window-content").addClass("k-overflow-x-hidden");
            },
            activate: function (e) {
                lsport.lastZ = (kendo.parseInt($(".k-overlay").css("z-index")) || 50100) + 10;
                e.sender.wrapper.css("z-index", lsport.lastZ);
                setTimeout(function () {
                    var top = e.sender.wrapper.offset().top;
                    var btm = top + e.sender.wrapper.outerHeight();
                    var wtop = $(window).scrollTop();
                    var wbtm = wtop + $(window).height();
                    if (!(top > wtop && btn < wbtm)) window.scrollTo(0, top - 100);
                    if (window.lsport.alertShowCallback) {
                        var cb = window.lsport.alertShowCallback;
                        window.lsport.alertShowCallback = null;
                        if (cb) cb(e);
                    }
                })
            },
            close: function () {
                if (window.lsport.alertCallback) {
                    var cb = window.lsport.alertCallback;
                    window.lsport.alertCallback = null;
                    if (cb) cb();
                }
            }
        }).getKendoWindow();
        $("#alert-close").click(function () {
            window.lsport.winAlert.close();
            if (window.lsport.alertCallback) {
                var cb = window.lsport.alertCallback;
                window.lsport.alertCallback = null;
                cb();
            }
        });
    }
    $("#alert-content").html(msg);
    $("#alert-close").text(btn || "OK");
    window.lsport.alertCallback = callback;
    window.lsport.alertShowCallback = activateCallback;
    lsport.winAlert.open().center();
}
function confirm2(msg, title, btnOK, btnCancel, callbackOK, callbackCancel) {
    var win = $('<div class="modal fade" tabindex="-1" role="dialog" style="z-index:30000"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">' + (title ? title : "") + '</h4></div><div class="modal-body">' + msg + '</div><div class="modal-footer"><button type="button" class="btn btn-lg btn-success" data-dismiss="modal">' + (btnOK ? btnOK : "Да") + '</button><button type="button" class="btn btn-sm btn-danger" data-dismiss="modal">' + (btnCancel ? btnCancel : "Нет") + '</button></div></div></div></div>');
    if (callbackOK) win.find(".btn-success").click(callbackOK);
    if (callbackCancel) win.find(".btn-danger").click(callbackCancel);
    win.modal("show");
}
function ask(msg, title, buttons, callback) {
    var winCode = '<div class="modal fade" tabindex="-1" role="dialog" style="z-index:30000"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">' + (title ? title : "") + '</h4></div><div class="modal-body">' + msg + '</div><div class="modal-footer">';
    $.each(buttons, function (i, btn) {
        winCode += '<button type="button" data-idx=' + i + ' class="btn btn-sm btn-primary" data-dismiss="modal">' + btn + '</button>';
    });
    winCode += '</div></div></div></div>';
    var win = $(winCode);
    win.on("click", "button", function (e) { callback(kendo.parseInt($(e.currentTarget).attr("data-idx"))); })
    win.modal("show");
}
$(function () {
    $(document).on('hidden.bs.modal', '.modal', function () {
        $('.modal:visible').length && $(document.body).addClass('modal-open');
    }).on('shown.bs.modal', function () {
        $(document).off('focusin.modal');
    });
    $('.tooltips').tooltip();
    $('.popovers').popover();
    $('#sidebar .sub-menu > a').click(function () {
        var last = $('.sub-menu.open', $('#sidebar'));
        $('.menu-arrow').removeClass('arrow_carrot-right');
        $('.sub', last).slideUp(200);
        var sub = $(this).next();
        if (sub.is(":visible")) {
            $('.menu-arrow').addClass('arrow_carrot-right');
            sub.slideUp(200);
        } else {
            $('.menu-arrow').addClass('arrow_carrot-down');
            sub.slideDown(200);
        }
        var o = ($(this).offset());
        diff = 200 - o.top;
        if (diff > 0)
            $("#sidebar").scrollTo("-=" + Math.abs(diff), 500);
        else
            $("#sidebar").scrollTo("+=" + Math.abs(diff), 500);
    });
    $('.toggle-nav').click(function () {
        $('#side-bar').toggleClass("d-none");
        $("#main-content").css("max-width", ($(window).width() - $("#side-bar").width()) + "px");
    });

    function responsiveView() {
        var wSize = $(window).width();
        if (wSize <= 768) {
            $('#side-bar').addClass('d-none');
            //$('#sidebar > ul').hide();
        }

        if (wSize > 768) {
            //$('#sidebar > ul').show();
            $('#side-bar').removeClass('d-none');
            $("#container").removeClass("sidebar-closed");
        }
        $("#main-content").css("max-width", ($(window).width() - $("#side-bar").width()) + "px");
    }
    $(window).on('load', responsiveView);
    $(window).on('resize', responsiveView);
    $('#menu-top .dropdown').hover(function () {
        $(this).find('.dropdown-menu').first().stop(true, true).delay(250).slideDown('fast');
    }, function () {
        $(this).find('.dropdown-menu').first().stop(true, true).delay(100).slideUp('fast')
    });
});
if (!"".replaceAll) { String.prototype.replaceAll = function replaceAll(search, replace) { return this.split(search).join(replace); }; }
lsport.connectSR = function () {
    if (!lsport.hubCallbacks) {
        lsport.hubCallbacks = $.Callbacks("memory");
        lsport.hubGroups = {};
        $.connection.hub.logging = true;
        $.connection.hub.reconnected(function () {
            lsport.hubCallbacks.fire($.connection.hub);
            if (lsport.hubNotify) lsport.hubNotify.hide();
        });
        $.connection.hub.received(function () {
            if (lsport.hubNotify) lsport.hubNotify.hide();
        });
        $.connection.hub.disconnected(function () {
            setTimeout(function () { $.connection.hub.start(); }, 3000);
            if (!lsport.hubNotify) {
                lsport.hubNotify = $("<span></span>").appendTo($("body")).kendoNotification({
                    width: "20em", autoHideAfter: 0
                }).getKendoNotification();
            }
            if (lsport.hubNotify) lsport.hubNotify.hide();
            if (lsport.gotSRCallback) lsport.hubNotify.error("Потеряно соединение с сервером. Пытаемся его восстановить.  Можете попробовать обновить страницу");
        });
        $.connection.notify.client.notify = function (id, hubID, data) {
            if (lsport.hubGroups[id]) {
                var d;
                try { d = $.parseJSON(data, true); }
                catch (ex) { d = data; }
                lsport.hubGroups[id].fire(d, hubID);
            }
        }
        $.connection.hub.start().done(function () {
            lsport.hubCallbacks.fire($.connection.hub);
        });
    }
}
lsport.addHubCallback = function (id, fnc) {
    lsport.connectSR();
    lsport.gotSRCallback = true;
    if (!lsport.hubGroups[id]) {
        lsport.hubCallbacks.add(function () { $.connection.notify.server.track(id); });
        lsport.hubGroups[id] = $.Callbacks("unique");
    }
    lsport.hubGroups[id].add(fnc);
}
lsport.logout = function (e, callback) {
    if (e) e.preventDefault();
    $("body").block(loaderSettings);
    $.ajax({
        type: "POST",
        url: "/data/Auth/LogOut",
        dataType: "json",
        success: function (resp) {
            if (callback) callback(resp);
            else location.href = "/";
        }
    });
}
$.fn.block = function () {
    kendo.ui.progress($(this), true);
    return $(this);
};
$.fn.unblock = function (opts) {
    kendo.ui.progress($(this), false);
    return $(this);
};